<%= render "shared/navbar" %>

<div class="min-h-screen bg-base-100 py-8">
  <div class="container mx-auto max-w-2xl px-4">
    
    <!-- Back Button -->
    <div class="mb-6">
      <%= link_to user_path(@user), class: "btn btn-ghost btn-sm" do %>
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
        </svg>
        Back to Profile
      <% end %>
    </div>
    
    <!-- Post Detail Card -->
    <div class="card bg-base-100 shadow-lg border border-base-200">
      <div class="card-body p-6">
        
        <!-- Post Header -->
        <div class="flex items-center justify-between mb-6">
          <div class="flex items-center gap-3">
            <div class="avatar">
              <div class="w-12 h-12 rounded-full">
                <% if @user.avatar.attached? %>
                  <%= image_tag @user.avatar, class: "w-full h-full object-cover" %>
                <% else %>
                  <%= image_tag "avatar.png", class: "w-full h-full object-cover" %>
                <% end %>
              </div>
            </div>
            <div>
              <%= link_to user_path(@user), class: "hover:underline" do %>
                <h3 class="font-semibold"><%= @user.username %></h3>
              <% end %>
              <p class="text-sm text-base-content/60"><%= time_ago_in_words(@post.created_at) %> ago</p>
            </div>
          </div>
          <% if @user == Current.user %>
            <div class="dropdown dropdown-end">
              <button class="btn btn-ghost btn-sm btn-circle" tabindex="0">
                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                  <path d="M12 8c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm0 2c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm0 6c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z"/>
                </svg>
              </button>
              <ul tabindex="0" class="dropdown-content menu p-2 shadow bg-base-100 rounded-box w-32">
                <%= link_to edit_post_path(@post), class: "block" do %>
                  <li><a class="text-sm">Edit Post</a></li>
                <% end %>
                <%= button_to post_path(@post), method: :delete, 
                    data: { confirm: "Are you sure you want to delete this post?" }, 
                    class: "block w-full" do %>
                  <li><a class="text-sm text-error">Delete</a></li>
                <% end %>
              </ul>
            </div>
          <% end %>
        </div>
        
        <!-- Post Content -->
        <div class="mb-6">
          <%= @post.content %>
        </div>
        
        <!-- Post Stats -->
        <div class="flex items-center gap-6 mb-6 text-sm text-base-content/60">
          <span><%= @post.likes.count %> likes </span>
          <span><%= @post.comments.count %> comments </span>
        </div>
        
        <!-- Post Actions -->
        <div class="flex items-center justify-between py-3 border-y border-base-200 mb-6">
          <% if @post.likes.find_by(user: Current.user) %>
            <div id="unlike-btn-for-post-<%= @post.id %>">
              <%= button_to unlike_post_path(@post), method: :delete, class: "flex items-center gap-2 text-red-500 hover:text-red-600 transition-colors", data: {turbo_stream: true} do %>
                <svg class="w-5 h-5" fill="currentColor" stroke="none" viewBox="0 0 24 24">
                  <path d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z" />
                </svg>
                <span>Liked</span>
              <% end %>
            </div>
          <% else %>
            <div id="like-btn-for-post-<%= @post.id %>">
              <%= button_to like_post_path(@post), class: "flex items-center gap-2 text-base-content/60 hover:text-primary transition-colors", data: {turbo_stream: true} do %>
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z" />
                </svg>
                <span>Like</span>
              <% end %>
            </div>
          <% end %>
          <button class="flex items-center gap-2 text-base-content/60 hover:text-accent transition-colors">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.367 2.684 3 3 0 00-5.367-2.684z" />
            </svg>
            <span>Share</span>
          </button>
        </div>
        
        <!-- Comments Section -->
        <div class="space-y-4">
          <h4 class="font-semibold text-lg">Comments (<span id="comments_count"><%= @post.comments.count %></span>)</h4>
          
          <!-- Add Comment -->
          <%= form_with model: [@post, @post.comments.build], data: {controller: "resetform", action: "turbo:submit-end->resetform#reset"} do |form| %>
            <div class="flex gap-3">
              <div class="avatar">
                <div class="w-8 h-8 rounded-full">
                  <% if Current.user.avatar.attached? %>
                    <%= image_tag Current.user.avatar, class: "w-full h-full object-cover" %>
                  <% else %>
                    <%= image_tag "avatar.png", class: "w-full h-full object-cover" %>
                  <% end %>
                </div>
              </div>
              <div class="flex-1">
                <%= form.text_area :content, class: "textarea textarea-bordered w-full resize-none", 
                    placeholder: "Write a comment...", rows: 2 %>
                <div class="flex justify-end mt-2">
                  <%= form.submit "Post Comment", class: "btn btn-primary btn-sm" %>
                </div>
              </div>
            </div>
          <% end %>
          
          <!-- Comments List -->
          <div class="space-y-4" id="comments_container">
            <% @post.comments.includes(:user).order(created_at: :desc).each do |comment| %>
              <div class="flex gap-3" id="comment_<%= comment.id %>">
                <div class="avatar">
                  <div class="w-8 h-8 rounded-full">
                    <% if comment.user.avatar.attached? %>
                      <%= image_tag comment.user.avatar, class: "w-full h-full object-cover" %>
                    <% else %>
                      <%= image_tag "avatar.png", class: "w-full h-full object-cover" %>
                    <% end %>
                  </div>
                </div>
                <div class="flex-1">
                  <div class="bg-base-200 rounded-lg p-3">
                    <div class="flex items-center gap-2 mb-1">
                      <%= link_to user_path(comment.user), class: "hover:underline" do %>
                        <span class="font-semibold text-sm"><%= comment.user.username %></span>
                      <% end %>
                      <span class="text-xs text-base-content/60"><%= time_ago_in_words(comment.created_at) %> ago</span>
                    </div>
                    <p class="text-sm"><%= comment.content %></p>
                  </div>
                  <div class="flex items-center gap-4 mt-2 text-xs text-base-content/60">
                    <div id="comment_like_btn_<%= comment.id %>">
                      <% if comment.likes.find_by(user: Current.user) %>
                        <%= button_to unlike_comment_path(comment), method: :delete, 
                            class: "hover:text-primary text-red-500", 
                            data: { turbo_stream: true } do %>
                          Liked
                        <% end %>
                      <% else %>
                        <%= button_to like_comment_path(comment), 
                            class: "hover:text-primary", 
                            data: { turbo_stream: true } do %>
                          Like
                        <% end %>
                      <% end %>
                    </div>
                    <div id="comment_likes_count_<%= comment.id %>">
                      <span><%= pluralize(comment.likes.count, 'like') %></span>
                    </div>
                    <% if comment.user == Current.user %>
                      <%= button_to comment_path(comment), method: :delete, 
                          data: { confirm: "Are you sure you want to delete this comment?", turbo_stream: true },
                          class: "hover:text-error text-xs" do %>
                        Delete
                      <% end %>
                    <% end %>
                  </div>
                </div>
              </div>
            <% end %>
            
            <% if @post.comments.empty? %>
              <div class="text-center py-8 text-base-content/40" id="no_comments_message">
                <p>No comments yet. Be the first to comment!</p>
              </div>
            <% end %>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
